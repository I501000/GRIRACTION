# filter-node-package

This script can be used to filter out internal data that should not be delivered to customers.

According to Product Standard Security [SEC-236](https://wiki.wdf.sap.corp/wiki/display/PSSEC/SEC-236)
internal information should not be disclosed.
> SAP internal URLs (such as Wiki links, portal links, demo systems etc.) shall not be a part of the
released software packages and documentation.

Also according to [SEC-246](https://wiki.wdf.sap.corp/wiki/display/PSSEC/SEC-246)
> SAP products shall not contain undocumented features. This includes outdated code, as well as
debugging and test code that remained in the delivered product, but is not part of the contracted
functionality as described in the product documentation as available to the customer or the
operating staff.

Filtering is necessary if you create an xmake "bundle build".

The script performs these types of filtering:
* It removes properties containing SAP-internal URLs from *package.json*, *package-lock.json* and *npm-shrinkwrap.json*
of the current package and all its dependencies, i.e. recursively under node_modules.
* It can also delete files and directories which should not be packaged, like tests.
This is based on a whitelist.
* Checks if any project file (excluding node_modules) contains internal URLs

This script should be executed before packaging and publishing to Nexus.

**Note:** since v2.0.0 the script will abort, if any project file contains internal URLs.
To use the old behavior where internal URLs are just logged, call the script like this:
`clean-packages --warn-only`

## xmake bundle build

You have an xmake bundle build if your .xmake.cfg contains the following property:
```
[buildplugin]
bundle=true
```
In this case, xmake produces a self-contained npm package (=bundle) containing all the dependent
node_modules of your package by calling `npm install`.
This step adds SAP internal URLs to package.json files of the installed modules.
Therefore, a filter script has to run after xmake finished building your project but before upload
to Nexus happens.

## Integrating the filtering script

If you have a bundle build you have to run a filter script after the xmake build and right before
the upload to Nexus happens. Please run through all of these steps:

#### Add the package _filter-node-package_ as a dev dependency:
```sh
npm install --save-dev filter-node-package
```
#### List files and directories to keep in your package.json:
Everything else will be deleted.
```
"files": [
  "index.js",
  "lib",
  ...
]
```
Some files/dirs are never deleted:
  - .git
  - package.json
  - package-lock.json
  - npm-shrinkwrap.json
  - README.md
  - CHANGELOG.md
  - node_modules

As a fallback if `files` is not defined, the script reads the list of files to keep
from `bundle.json` if present.
See [whitelist-for-node-packages](https://github.wdf.sap.corp/xs2/whitelist-for-node-packages).

This functionality emulates what [npm publish](https://docs.npmjs.com/files/package.json#files)
does until it is implemented in xmake.
`.npmignore` is not supported in this script yet.

#### Add the  `before_publish` property to your .xmake.cfg:
```
[buildplugin]
before_publish=prepareRelease
```

#### Add the `prepareRelease` script call to the `scripts` section of your package.json:
```
...
"scripts" : {
  ...
  "prepareRelease": "clean-packages && npm prune --production"
},
...
```

## Ready!

Done! The next build_and_deploy xmake build will filter your package.

## Further Reading

The full background of why filtering is necessary is described in the Corporate Wiki :
https://wiki.wdf.sap.corp/wiki/display/xs2/Filtering+SAP-internal+metadata+before+release


