'use strict';

var fs = require('fs');
var rimraf = require('rimraf');

module.exports = clean;

function clean() {
  // see https://docs.npmjs.com/files/package.json#files
  var pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
  var files = pkg.files;
  if (!Array.isArray(files)) {
    // fallback
    if (!fs.existsSync('bundle.json')) {
      return;
    }
    var bundle = JSON.parse(fs.readFileSync('bundle.json', 'utf8'));
    files = bundle.bundle_includes;
    if (!Array.isArray(files)) {
      return;
    }
  }
  if (files.length === 0) {
    return;
  }

  var keep = {
    '.git': true,
    'package.json': true,
    'package-lock.json': true,
    'npm-shrinkwrap.json': true,
    'README.md': true,
    'CHANGELOG.md': true,
    'node_modules': true
  };
  for (var i = 0; i < files.length; ++i) {
    keep[files[i]] = true;
  }

  var erase = fs.readdirSync('.').filter(function(f) { return !keep[f]; });
  if (erase.length > 0) {
    console.log("Deleting", erase);
    erase.forEach(function del(f) {
      rimraf.sync(f, { glob: false });
    });
  }
}
